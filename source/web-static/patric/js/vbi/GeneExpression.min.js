Ext.define("VBI.GeneExpression.model.CategoryCount",{extend:"Ext.data.Model",idProperty:"rownum",fields:[{name:"rownum",type:"int"},{name:"category",type:"string"},{name:"count",type:"int"}]});Ext.define("VBI.GeneExpression.model.Gene",{extend:"Ext.data.Model",idProperty:"pid",fields:["exp_id","exp_accession","exp_platform","exp_samples",{name:"pid",type:"int"},"exp_locustag",{name:"exp_pavg",type:"float",useNull:false},{name:"exp_pratio",type:"float",useNull:false},{name:"exp_zscore",type:"float",useNull:false},"exp_name","exp_channels","exp_timepoint","exp_organism","exp_strain","exp_mutant","exp_condition","pmid","na_feature_id","patric_locus_tag","figfam_id",{name:"exp_geneid",type:"int"}]});Ext.define("VBI.GeneExpression.store.Conditions",{extend:"Ext.data.Store",model:"VBI.GeneExpression.model.CategoryCount",proxy:{type:"ajax",url:"/portal/portal/patric/TranscriptomicsGeneExp/TranscriptomicsGeneExpWindow?action=b&cacheability=PAGE",extraParams:{storeType:"condition"},pageParam:undefined,startParam:undefined,limitParam:undefined,reader:{type:"json",root:"exp_stat"},noCache:false},autoLoad:true,listeners:{beforeload:function(c,a,b){c.proxy.extraParams=Ext.Object.merge(c.proxy.extraParams,VBI.GeneExpression.param)},load:function(c,a,e,b){if(e){var d=new Array();for(i=0;i<a.length;i++){if(a[i].get("rownum")<7){if(a[i].get("category")!="N/A"){d[i]=a[i].data}}}d=Ext.Array.splice(Ext.Array.clean(d),0,5);Ext.getStore("ConditionsTop5").loadData(d);Ext.getStore("ConditionsTop5").sort("count","ASC")}}}});Ext.define("VBI.GeneExpression.store.ConditionsTop5",{extend:"Ext.data.Store",model:"VBI.GeneExpression.model.CategoryCount",autoLoad:false});Ext.define("VBI.GeneExpression.store.Genes",{extend:"Ext.data.Store",model:"VBI.GeneExpression.model.Gene",proxy:{type:"ajax",url:"/portal/portal/patric/TranscriptomicsGeneExp/TranscriptomicsGeneExpWindow?action=b&cacheability=PAGE",extraParams:{storeType:"features"},pageParam:undefined,startParam:undefined,limitParam:undefined,reader:{type:"json",root:"results"},noCache:false},autoLoad:true,listeners:{beforeload:function(b,a,c){b.proxy.extraParams=Ext.Object.merge(b.proxy.extraParams,VBI.GeneExpression.param)},load:function(){this.updateRecordCount()}},updateRecordCount:function(){count=this.getCount();(count==1)?countStr=count+" comparison":countStr=count+" comparisons";Ext.getCmp("filterReport").setText("<b>"+countStr+"</b>")},filterField:function(b,a){this.filter([Ext.create("Ext.util.Filter",{filterFn:function(c){if(c.get(b)>=a||c.get(b)<=(-1)*a){return true}else{return false}}})])},filterOnFly:function(a){this.clearFilter();if(a.keyword!=null&&a.keyword!=""){this.filter([Ext.create("Ext.util.Filter",{property:"exp_name",value:a.keyword,root:"data",anyMatch:true})])}if(a.log_ratio>0){this.filterField("exp_pratio",a.log_ratio)}if(a.zscore>0){this.filterField("exp_zscore",a.zscore)}this.updateRecordCount()}});Ext.define("VBI.GeneExpression.store.LogRatios",{extend:"Ext.data.Store",model:"VBI.GeneExpression.model.CategoryCount",proxy:{type:"ajax",url:"/portal/portal/patric/TranscriptomicsGeneExp/TranscriptomicsGeneExpWindow?action=b&cacheability=PAGE",extraParams:{storeType:"log_ratio"},pageParam:undefined,startParam:undefined,limitParam:undefined,reader:{type:"json",root:"exp_stat"},noCache:false},autoLoad:true,listeners:{beforeload:function(c,a,b){c.proxy.extraParams=Ext.Object.merge(c.proxy.extraParams,VBI.GeneExpression.param);Ext.get("p-chartlogratio").mask("loading")},load:function(){Ext.get("p-chartlogratio").unmask()}}});Ext.define("VBI.GeneExpression.store.Mutants",{extend:"Ext.data.Store",model:"VBI.GeneExpression.model.CategoryCount",proxy:{type:"ajax",url:"/portal/portal/patric/TranscriptomicsGeneExp/TranscriptomicsGeneExpWindow?action=b&cacheability=PAGE",extraParams:{storeType:"mutant"},pageParam:undefined,startParam:undefined,limitParam:undefined,reader:{type:"json",root:"exp_stat"},noCache:false},autoLoad:true,listeners:{beforeload:function(c,a,b){c.proxy.extraParams=Ext.Object.merge(c.proxy.extraParams,VBI.GeneExpression.param)},load:function(c,a,e,b){if(e){var d=new Array();for(i=0;i<a.length;i++){if(a[i].get("rownum")<7){if(a[i].get("category")!="N/A"){d[i]=a[i].data}}}d=Ext.Array.splice(Ext.Array.clean(d),0,5);Ext.getStore("MutantsTop5").loadData(d);Ext.getStore("MutantsTop5").sort("count","ASC")}}}});Ext.define("VBI.GeneExpression.store.MutantsTop5",{extend:"Ext.data.Store",model:"VBI.GeneExpression.model.CategoryCount",autoLoad:false});Ext.define("VBI.GeneExpression.store.Strains",{extend:"Ext.data.Store",model:"VBI.GeneExpression.model.CategoryCount",proxy:{type:"ajax",url:"/portal/portal/patric/TranscriptomicsGeneExp/TranscriptomicsGeneExpWindow?action=b&cacheability=PAGE",extraParams:{storeType:"strain"},pageParam:undefined,startParam:undefined,limitParam:undefined,reader:{type:"json",root:"exp_stat"},noCache:false},autoLoad:true,listeners:{beforeload:function(c,a,b){c.proxy.extraParams=Ext.Object.merge(c.proxy.extraParams,VBI.GeneExpression.param);Ext.get("CategoryPieStrain").mask("loading")},load:function(c,a,e,b){Ext.get("CategoryPieStrain").unmask();if(e){var d=new Array();for(i=0;i<a.length;i++){if(a[i].get("rownum")<7){if(a[i].get("category")!="N/A"){d[i]=a[i].data}}}d=Ext.Array.splice(Ext.Array.clean(d),0,5);Ext.getStore("StrainsTop5").loadData(d);Ext.getStore("StrainsTop5").sort("count","ASC")}}}});Ext.define("VBI.GeneExpression.store.StrainsTop5",{extend:"Ext.data.Store",model:"VBI.GeneExpression.model.CategoryCount",autoLoad:false});Ext.define("VBI.GeneExpression.store.ZScores",{extend:"Ext.data.Store",model:"VBI.GeneExpression.model.CategoryCount",proxy:{type:"ajax",url:"/portal/portal/patric/TranscriptomicsGeneExp/TranscriptomicsGeneExpWindow?action=b&cacheability=PAGE",extraParams:{storeType:"z_score"},pageParam:undefined,startParam:undefined,limitParam:undefined,reader:{type:"json",root:"exp_stat"},noCache:false},autoLoad:true,listeners:{beforeload:function(b,a,c){b.proxy.extraParams=Ext.Object.merge(b.proxy.extraParams,VBI.GeneExpression.param)}}});Ext.define("VBI.GeneExpression.view.CategoryBarChart",{extend:"Ext.chart.Chart",alias:"widget.categorybarchart",axes:[{type:"Numeric",position:"bottom",fields:["count"],title:"Comparisions",minimum:0,majorTickSteps:1},{type:"Category",position:"left",fields:["category"]}],series:[{type:"bar",yField:"count",xField:"category",label:{display:"insideEnd",field:"count",contrast:true}}],theme:"PATRIC"});Ext.define("VBI.GeneExpression.view.CategoryPieChart",{extend:"Ext.chart.Chart",alias:"widget.categorypiechart",animate:true,series:[{type:"pie",field:"count",highlight:{segment:{margin:20}},donut:20,label:{field:"category",display:"rotate",contrast:true}}],theme:"PATRIC"});function BasicRenderer(e,d,a,f,c,b){d.tdAttr='data-qtip="'+e+'" data-qclass="x-tip"';return e}Ext.define("VBI.GeneExpression.view.FeatureGrid",{extend:"Ext.grid.Panel",alias:"widget.featuregrid",store:"Genes",autoScroll:true,columns:[{dataIndex:"exp_platform",header:"Platform",flex:1,hidden:true},{dataIndex:"exp_samples",header:"Samples",flex:1,hidden:true},{dataIndex:"exp_locustag",header:"Locus Tag",flex:1,hidden:true},{dataIndex:"exp_name",header:"Title",flex:4,renderer:function(f,e,b,h,d,c){var a=VBI.GeneExpression.param.log_ratio||0,g=VBI.GeneExpression.param.zscore||0;return Ext.String.format('<a href="TranscriptomicsGene?cType=taxon&cId={1}&dm=result&expId={2}&sampleId={3}&colId=&log_ratio={4}&zscore={5}" target="_blank">{0}</a>',f,2,b.data.exp_id,b.data.pid,a,g)}},{dataIndex:"pmid",header:"PubMed",flex:1,renderer:function(e,d,a,f,c,b){if(e!=undefined&&e!=""){return Ext.String.format('<a href="http://www.ncbi.nlm.nih.gov/pubmed/{0}" target="_blank">{0}</a>',e)}else{return""}}},{dataIndex:"exp_accession",header:"Accession",flex:1,renderer:function(e,d,a,f,c,b){if(e!=undefined&&e!=""){return Ext.String.format('<a href="http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc={0}" target="_blank">{0}</a>',e)}else{return""}}},{dataIndex:"exp_strain",header:"Strain",flex:1,renderer:BasicRenderer},{dataIndex:"exp_mutant",header:"Gene Modification",flex:1,renderer:BasicRenderer},{dataIndex:"exp_condition",header:"Experimental Condition",flex:2,renderer:BasicRenderer},{dataIndex:"exp_timepoint",header:"Time Point",flex:1,align:"center"},{dataIndex:"exp_pavg",header:"Avg Intensity",flex:1},{dataIndex:"exp_pratio",header:"Log Ratio",flex:1},{dataIndex:"exp_zscore",header:"Z-score",flex:1}]});Ext.define("VBI.GeneExpression.view.FilterPanel",{extend:"Ext.panel.Panel",alias:"widget.filterpanel",bodyPadding:5,layout:"hbox",items:[{xtype:"textfield",itemId:"keyword",width:200,hideLabel:true,allowBlank:true,value:"",emptyText:"keyword",scope:this},{xtype:"tbspacer",width:20},{xtype:"combobox",itemId:"log_ratio",fieldLabel:"|Log Ratio|",queryMode:"local",displayField:"name",labelWidth:65,width:120,value:0,store:Ext.create("Ext.data.Store",{fields:["name"],data:[{name:"0"},{name:"0.5"},{name:"1"},{name:"1.5"},{name:"2"},{name:"2.5"},{name:"3"}]}),editable:false},{xtype:"tbspacer",width:20},{xtype:"combobox",itemId:"zscore",fieldLabel:"|Z-score|",queryMode:"local",displayField:"name",labelWidth:55,width:120,value:0,store:Ext.create("Ext.data.Store",{fields:["name"],data:[{name:"0"},{name:"0.5"},{name:"1"},{name:"1.5"},{name:"2"},{name:"2.5"},{name:"3"}]}),editable:false},{xtype:"tbspacer",width:20},{xtype:"button",text:"Filter",handler:function(){var a=new Object();a.keyword=this.ownerCt.getComponent("keyword").getValue();a.log_ratio=this.ownerCt.getComponent("log_ratio").getValue();a.zscore=this.ownerCt.getComponent("zscore").getValue();this.fireEvent("filter",a)}},{xtype:"tbspacer",width:20},{xtype:"button",text:"Reset Filter",handler:function(){this.ownerCt.getComponent("keyword").setValue("");this.ownerCt.getComponent("log_ratio").setValue(0);this.ownerCt.getComponent("zscore").setValue(0);this.fireEvent("reset")}},{xtype:"tbspacer",width:20},{xtype:"button",text:"Show All Comparisons",handler:function(){this.ownerCt.getComponent("log_ratio").setValue(0);this.ownerCt.getComponent("zscore").setValue(0);this.fireEvent("showall")}}]});Ext.chart.theme.PATRIC=Ext.extend(Ext.chart.theme.Base,{constructor:function(a){Ext.chart.theme.Base.prototype.constructor.call(this,Ext.apply({colors:["rgb(56, 93, 117)","rgb(109,156,47)","rgb(246, 218, 98)","rgb(147, 181, 208)","rgb(172, 233, 93)","rgb(206, 192, 142)"]},a))}});Ext.define("VBI.GeneExpression.view.Viewport",{extend:"Ext.panel.Panel",renderTo:"expression_panel",layout:"border",minHeight:600,minWidth:700,width:967,height:700,items:[{region:"north",border:false,height:35,xtype:"filterpanel",id:"p-filterpanel"},{region:"south",border:false,height:400,xtype:"featuregrid",dockedItems:[{xtype:"toolbar",height:30,dock:"top",items:["->",{xtype:"tbtext",text:"Download table in "},{xtype:"tbspacer",width:5},{xtype:"button",scale:"small",iconAlign:"left",text:"Excel file (.xlsx)",icon:"/patric/images/toolbar_excel.png",handler:function(a){a.fireEvent("downloadGrid","xlsx")}},"|",{xtype:"button",scale:"small",iconAlign:"left",text:"Text file (.txt)",icon:"/patric/images/toolbar_text.png",handler:function(a){a.fireEvent("downloadGrid","txt")}}]}]},{region:"center",layout:{type:"hbox"},items:[{xtype:"tabpanel",width:480,height:241,items:[{xtype:"chart",title:"Log Ratio",id:"p-chartlogratio",store:"LogRatios",theme:"PATRIC",axes:[{type:"Numeric",position:"left",fields:["count"],title:"Comparisons",minimum:0},{type:"Category",position:"bottom",fields:["category"],title:"Log Ratio"}],series:[{type:"column",yField:"count",xField:"category",label:{display:"insideEnd",field:"count",contrast:true}}]},{xtype:"chart",title:"Z-score",id:"p-chartzscore",store:"ZScores",theme:"PATRIC",axes:[{type:"Numeric",position:"left",fields:["count"],title:"Comparisons",minimum:0},{type:"Category",position:"bottom",fields:["category"],title:"Z-score"}],series:[{type:"column",yField:"count",xField:"category",label:{display:"insideEnd",field:"count",contrast:true}}]}]},{xtype:"tabpanel",width:485,height:241,items:[{xtype:"tabpanel",title:"Strain",tabPosition:"left",bodyBorder:false,tabBar:{plain:true,baseCls:""},items:[{xtype:"categorypiechart",title:"All",iconCls:"icon-pie-chart",id:"CategoryPieStrain",store:"Strains"},{xtype:"categorybarchart",title:"Top 5",iconCls:"icon-bar-chart",id:"CategoryBarStrain",store:"StrainsTop5"}]},{xtype:"tabpanel",title:"Gene Modification",tabPosition:"left",bodyBorder:false,tabBar:{plain:true,baseCls:""},items:[{xtype:"categorypiechart",title:"All",iconCls:"icon-pie-chart",id:"CategoryPieMutant",store:"Mutants"},{xtype:"categorybarchart",title:"Top 5",iconCls:"icon-bar-chart",id:"CategoryBarMutant",store:"MutantsTop5"}]},{xtype:"tabpanel",title:"Experimental Condition",tabPosition:"left",bodyBorder:false,tabBar:{plain:true,baseCls:""},items:[{xtype:"categorypiechart",title:"All",iconCls:"icon-pie-chart",id:"CategoryPieCondition",store:"Conditions"},{xtype:"categorybarchart",title:"Top 5",iconCls:"icon-bar-chart",id:"CategoryBarCondition",store:"ConditionsTop5"}]}]}]}],dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"tbtext",height:15,text:"",id:"filterReport"}]}]});Ext.define("VBI.GeneExpression.controller.ViewController",{extend:"Ext.app.Controller",models:["Gene","CategoryCount"],views:["FilterPanel","FeatureGrid","CategoryPieChart","CategoryBarChart"],stores:["Genes","Strains","Mutants","Conditions","StrainsTop5","MutantsTop5","ConditionsTop5","LogRatios","ZScores"],init:function(){this.control({"filterpanel button":{reset:this.resetFilter,filter:this.doFilter,showall:this.showAll},"featuregrid > toolbar button":{downloadGrid:this.downloadGrid}})},resetFilter:function(){var a=new Object({keyword:"",threshold:"",strain:"",mutant:"",condition:""});VBI.GeneExpression.param=Ext.Object.merge(VBI.GeneExpression.param,a);Ext.getStore("Genes").clearFilter();Ext.getStore("Genes").updateRecordCount();Ext.getStore("LogRatios").load();Ext.getStore("ZScores").load();Ext.getStore("Strains").load();Ext.getStore("Mutants").load();Ext.getStore("Conditions").load()},doFilter:function(a){if(a!=null){VBI.GeneExpression.param=Ext.Object.merge(VBI.GeneExpression.param,a)}Ext.getStore("Genes").filterOnFly(VBI.GeneExpression.param);Ext.getStore("LogRatios").load();Ext.getStore("ZScores").load();Ext.getStore("Strains").load();Ext.getStore("Mutants").load();Ext.getStore("Conditions").load()},showAll:function(){var a=new Object({sampleId:"",keyword:"",threshold:"",strain:"",mutant:"",condition:""});VBI.GeneExpression.param=Ext.Object.merge(VBI.GeneExpression.param,a);Ext.getStore("Genes").proxy.extraParams=Ext.Object.merge(Ext.getStore("Genes").proxy.extraParams,VBI.GeneExpression.param);Ext.getStore("Genes").load();Ext.getStore("LogRatios").load();Ext.getStore("ZScores").load();Ext.getStore("Strains").load();Ext.getStore("Mutants").load();Ext.getStore("Conditions").load()},downloadGrid:function(b){var c=new Array();var a=Ext.getStore("Genes");Ext.Array.each(a.getRange(),function(e){c.push(e.get("pid"))});var d={na_feature_id:VBI.GeneExpression.param.featureId,pid:c.join(",")};Ext.getDom("fTableForm").action="/patric-searches-and-tools/jsp/grid_download_handler.jsp";Ext.getDom("fTableForm").target="";Ext.getDom("tablesource").value="GeneExpression";Ext.getDom("fileformat").value=b;Ext.getDom("fids").value=Ext.JSON.encode(d);Ext.getDom("idType").value="GeneExpression-Pid";Ext.getDom("fTableForm").submit()}});Ext.application({name:"VBI.GeneExpression",controllers:["ViewController"],param:{},autoCreateViewport:true,launch:function(){var a=new Object();a.featureId=Ext.getDom("featureId").value;a.sampleId=Ext.getDom("sampleId")?Ext.getDom("sampleId").value:"";a.log_ratio=Ext.getDom("log_ratio")?Ext.getDom("log_ratio").value:0;a.zscore=Ext.getDom("zscore")?Ext.getDom("zscore").value:0;if(a.log_ratio>0||a.zscore>0){fp=Ext.getCmp("p-filterpanel");fp.getComponent("log_ratio").setValue(a.log_ratio);fp.getComponent("zscore").setValue(a.zscore)}VBI.GeneExpression.param=a}});
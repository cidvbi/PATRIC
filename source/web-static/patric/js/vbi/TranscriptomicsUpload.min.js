Ext.define("TranscriptomicsUploader.model.GenomeName",{extend:"Ext.data.Model",idProperty:"ncbi_taxon_id",fields:[{name:"ncbi_taxon_id",type:"int"},{name:"genome_info_id",type:"int"},{name:"display_name",type:"string"}]});Ext.define("TranscriptomicsUploader.store.DataTypes",{extend:"Ext.data.Store",fields:["name","text"],data:[{name:"Transcriptomics",text:"Transcriptomics"},{name:"Proteomics",text:"Proteomics"},{name:"Phenomics",text:"Phenomics"}]});Ext.define("TranscriptomicsUploader.store.FileFormats",{extend:"Ext.data.Store",fields:["name","text"],data:[{name:"matrix",text:"Gene Matrix"},{name:"list",text:"Gene List"}]});Ext.define("TranscriptomicsUploader.store.FileTypes",{extend:"Ext.data.Store",fields:["name","text"],data:[{name:"csv",text:"Comma delimited (.csv)"},{name:"txt",text:"Tab delimited (.txt)"},{name:"xls",text:"Microsoft Excel (.xls)"},{name:"xlsx",text:"Microsoft Excel (.xlsx)"}]});Ext.define("TranscriptomicsUploader.store.GeneIDTypes",{extend:"Ext.data.Store",fields:["name","text"],data:[{name:"refseq_source_id",text:"RefSeq Locus Tag"},{name:"source_id",text:"PATRIC Locus Tag"}]});Ext.define("TranscriptomicsUploader.store.GenomeNames",{extend:"Ext.data.Store",model:"TranscriptomicsUploader.model.GenomeName",proxy:{type:"ajax",url:"/patric-common/jsp/genomeselector_support.json.jsp",startParam:undefined,limitParam:undefined,pageParam:undefined,noCache:false,reader:{type:"json",root:"genomeList",totalProperty:"totalCount"},extraParams:{mode:"search",start:2,searchon:"azlist"}}});Ext.define("TranscriptomicsUploader.store.WorkspaceGroups",{extend:"Ext.data.Store",fields:["name","description","tags"],proxy:{type:"ajax",url:"/portal/portal/patric/BreadCrumb/WorkspaceWindow?action=b&cacheability=PAGE&action_type=WSSupport&action=getGroupList&group_type=ExpressionExperiment",startParam:undefined,limitParam:undefined,pageParam:undefined,noCache:false,reader:{type:"json"}},listeners:{load:function(c,a,d,b){if(d){c.insert(0,{name:"Create New Group"});c.insert(0,{name:"None"})}}}});Ext.define("TranscriptomicsUploader.view.AddToGroup",{extend:"Ext.form.Panel",alias:"widget.addtogroup",border:false,bodyPadding:10,fieldDefaults:{labelWidth:80,anchor:"100%"},items:[{xtype:"displayfield",value:"<b>Specify a Group for this Experiment (optional)</b>"},{xtype:"combobox",name:"atg",fieldLabel:"Add to Group",store:"WorkspaceGroups",editable:false,displayField:"name",valueField:"name",id:"test_this_form",listeners:{added:function(b,a){b.select("None")},change:function(d,e,a,b){var c=d.up("form");if(a==undefined){return false}if(e=="None"){c.child("#groupName").setDisabled(true);c.child("#groupDesc").setDisabled(true)}else{if(e=="Create New Group"){c.child("#groupName").setDisabled(false);c.child("#groupName").setValue("");c.child("#groupName").focus();c.child("#groupName").setReadOnly(false);c.child("#groupDesc").setDisabled(false);c.child("#groupDesc").setValue("");c.child("#groupTag").setValue("")}else{record=d.getStore().findRecord("name",e,undefined,undefined,undefined,true);c.child("#groupName").setDisabled(false);c.child("#groupName").setValue(record.get("name"));c.child("#groupName").setReadOnly(true);c.child("#groupDesc").setDisabled(false);c.child("#groupDesc").setValue(record.get("description"));c.child("#groupDesc").setReadOnly(true);c.child("#groupTag").setValue(record.get("tags"))}}}}},{xtype:"textfield",itemId:"groupName",name:"group_name",emptyText:"New group name",disabled:true},{xtype:"textareafield",itemId:"groupDesc",name:"group_desc",emptyText:"Group Description",disabled:true},{xtype:"textfield",itemId:"groupTag",name:"tags",fieldLabel:"Group Tags",emptyText:"(comma separated)"}],buttons:[{text:"Previous",handler:function(){Ext.getCmp("uploader").getComponent("breadcrumb").setActiveTab("step03");Ext.getCmp("uploader").getComponent("steps").setActiveTab("step03")}},{text:"Save to Workspace",handler:function(b){var c=uploader.params.collectionId;var a=b.up("form").getForm();if(a.isValid()){a.submit({url:"/portal/portal/patric/BreadCrumb/WorkspaceWindow?action=b&cacheability=PAGE",params:{action_type:"groupAction",action:"create",group_type:"ExpressionExperiment",tracks:c},submitEmptyText:false,success:function(d,e){if(uploader.callback!=undefined){uploader.callback()}uploader.close()},failure:function(d,e){console.log("Form submission failed",e)}})}}}]});Ext.define("TranscriptomicsUploader.view.DescribeExperiment",{extend:"Ext.form.Panel",alias:"widget.describeexperiment",border:false,bodyPadding:10,fieldDefaults:{labelWidth:110,labelAlign:"right",anchor:"100%"},items:[{xtype:"displayfield",value:"<b>Provide additional information for this experiment</b>"},{xtype:"combobox",name:"data_type",fieldLabel:"Data Type",value:"Transcriptomics",store:"DataTypes",queryMode:"local",displayField:"text",valueField:"name",editable:false,afterRender:function(){var a=this.findParentByType("window");if(a.params!=undefined&&a.params.metaData!=undefined&&a.params.metaData.data_type!=undefined){this.setValue(a.params.metaData.data_type)}}},{xtype:"textfield",name:"experiment_title",fieldLabel:"Experiment Title",emptyText:"Title",allowBlank:false},{xtype:"textareafield",name:"experiment_description",fieldLabel:"Experiment <br/> Description",emptyText:"Description (optional)"},{xtype:"textfield",name:"organism_name",fieldLabel:"Organism Name",emptyText:"Organism Name (optional)"},{xtype:"numberfield",name:"pubmed_id",fieldLabel:"Pubmed ID",hideTrigger:true,keyNavEnabled:false,mouseWheelEnabled:false,emptyText:"Pubmed ID (optional)"}],buttons:[{text:"Previous",handler:function(){Ext.getCmp("uploader").getComponent("breadcrumb").setActiveTab("step02");Ext.getCmp("uploader").getComponent("steps").setActiveTab("step02")}},{text:"Next",formBind:true,disabled:true,handler:function(c,f){var d=uploader.params.collectionId;var a=uploader.params;a.parsed.snapshot=undefined;var b=c.up("form").getForm();Ext.Ajax.request({url:"/portal/portal/patric/BreadCrumb/TranscriptomicsUploaderWindow?action=b&cacheability=PAGE",params:{mode:"save_experiment",collectionId:d,extra:Ext.JSON.encode(a),data_type:b.findField("data_type").getValue(),experiment_title:b.findField("experiment_title").getValue(),experiment_description:b.findField("experiment_description").getValue(),organism_name:b.findField("organism_name").getValue(),pubmed_id:b.findField("pubmed_id").getValue()},timeout:60000,success:function(e){Ext.getCmp("uploader").getComponent("breadcrumb").setActiveTab("step04");Ext.getCmp("uploader").getComponent("steps").setActiveTab("step04")},failure:function(e){console.log("Failure",e)}})}}]});Ext.define("TranscriptomicsUploader.view.MapGeneIdentifiers",{extend:"Ext.form.Panel",alias:"widget.mapgeneidentifiers",border:false,bodyPadding:10,fieldDefaults:{labelAlign:"right"},id:"MapGeneIdentifiersPanel",initParsedResult:function(){var d=this;if(uploader.params.parsed==null){return false}var g=uploader.params.parsed;var c="<b>"+g.origFileName+" ("+g.countGeneIDs+" gene IDs, "+g.countSamples+" comparisons)";d.getComponent("parsed_label").setValue(c);var e=[],a=[],f=[],b,h;if(g.snapshot!=undefined&&g.snapshot.length>0){h=g.snapshot[0].line.split("\t");for(i=0;i<h.length;i++){if(i==0){a.push("C"+i);f.push({text:"Gene ID",dataIndex:"C"+i})}else{a.push("C"+i);f.push({text:"Column "+i,dataIndex:"C"+i})}}for(rowId=1;rowId<g.snapshot.length;rowId++){row=g.snapshot[rowId].line.split("\t");tmpDataRow={};for(i=0;i<h.length;i++){tmpDataRow["C"+i]=row[i]}e.push(tmpDataRow)}}b=Ext.create("Ext.grid.Panel",{store:{data:e,fields:a},columns:f,height:100});b.render(d.child("#parsed_result").el,0)},items:[{xtype:"displayfield",itemId:"parsed_label",value:""},{itemId:"parsed_result",height:100,anchor:"100%",readOnly:true},{xtype:"displayfield",padding:"10 0 0 0",value:"<b>Specify Gene ID type to map data into PATRIC</b>"},{xtype:"container",layout:"hbox",padding:"0 0 5px 0",items:[{xtype:"combobox",fieldLabel:"Gene ID Type",name:"geneIdType",width:300,value:"refseq_source_id",store:"GeneIDTypes",queryMode:"local",displayField:"text",valueField:"name",editable:false},{xtype:"component",autoEl:{tag:"a",href:"http://enews.patricbrc.org/faqs/transcriptomics-faqs/upload-transcriptomics-data-to-workspace-faqs/#gene-id-type",html:"what's this?",target:"_blank"},listeners:{afterrender:function(a){a.mon(a.el,"click",function(){Ext.create("Ext.tip.ToolTip",{target:a.el,html:"Gene ID Type describes the gene identifier scheme used in your source file.  PATRIC uses Gene ID Type to map your data to existing PATRIC functional annotations."})},this)}},padding:"0 0 0 15px"},{xtype:"label",text:"Don't see your ID Type (",padding:"0 0 0 5px"},{xtype:"component",autoEl:{tag:"a",href:"http://enews.patricbrc.org/faqs/transcriptomics-faqs/upload-transcriptomics-data-to-workspace-faqs",html:"FAQ",target:"_blank"}},{xtype:"label",text:")"}]},{xtype:"container",layout:"hbox",padding:"10 0 0 0",items:[{xtype:"displayfield",value:"<b>Map your genes into PATRIC</b>",width:200},{xtype:"button",id:"map_genes_btn",text:"Map Genes",margin:"0 0 0 20px",handler:function(d){var c=d.up("form").getForm();var e=uploader.params.collectionId;var b=c.findField("geneIdType").getValue();var a=new Ext.LoadMask(uploader.body,{msg:"Mapping genes"});a.show();Ext.Ajax.request({url:"/portal/portal/patric/BreadCrumb/TranscriptomicsUploaderWindow?action=b&cacheability=PAGE",params:{mode:"map_genes",collectionId:e,geneIdType:b},timeout:300000,success:function(f){mapped_result=Ext.JSON.decode(f.responseText);uploader.params.mapping=mapped_result;pPanel=d.findParentByType("panel");pPanel.child("#mapping_result").child("#msg").setValue(mapped_result.msg);var g;if(mapped_result.geneMissed==0){g="/patric/images/icon-green-check-22x22.png"}else{if(mapped_result.geneMissed==mapped_result.geneTotal){g="/patric/images/icon-red-x-22x22.png"}else{g="/patric/images/icon-orange-warning-22x22.png"}}pPanel.child("#mapping_result").child("#icon").setSrc(g);Ext.getCmp("next_btn_to_experiment").setDisabled(false);a.hide()},failure:function(f){console.log(f.status);a.hide()}})}}]},{xtype:"container",layout:"hbox",padding:"15px 0 0 0",itemId:"mapping_result",items:[{xtype:"imagecomponent",itemId:"icon",src:"",height:22,width:22},{xtype:"displayfield",itemId:"msg",name:"mapping_result",padding:"0 0 0 3px",value:"You must map your genes into PATRIC before procedding to the next step"}]}],buttons:[{text:"Previous",handler:function(){Ext.getCmp("uploader").getComponent("breadcrumb").setActiveTab("step01");Ext.getCmp("uploader").getComponent("steps").setActiveTab("step01");this.findParentByType("panel").child("#mapping_result").child("#msg").reset();this.findParentByType("panel").child("#mapping_result").child("#icon").setSrc("")}},{text:"Next",id:"next_btn_to_experiment",disabled:true,handler:function(){Ext.getCmp("uploader").getComponent("breadcrumb").setActiveTab("step03");Ext.getCmp("uploader").getComponent("steps").setActiveTab("step03")}}]});Ext.define("TranscriptomicsUploader.view.SpecifyFile",{extend:"Ext.form.Panel",alias:"widget.specifyfile",border:false,bodyPadding:10,fieldDefaults:{msgTarget:"under",labelAlign:"right"},items:[{xtype:"displayfield",value:"<b>Specify omic data type</b>"},{xtype:"combobox",name:"data_type",fieldLabel:"Data Type",labelWidth:180,width:350,store:"DataTypes",queryMode:"local",displayField:"text",valueField:"name",editable:false,afterRender:function(){var a=this.findParentByType("window");if(a.params!=undefined&&a.params.metaData!=undefined&&a.params.metaData.data_type!=undefined){this.setValue(a.params.metaData.data_type)}}},{xtype:"displayfield",value:"<b>Specify the file type to upload</b>"},{xtype:"combobox",name:"file0_type",fieldLabel:"File Type",labelWidth:180,width:350,value:"txt",store:"FileTypes",queryMode:"local",displayField:"text",valueField:"name",editable:false},{xtype:"container",layout:"hbox",padding:"0 0 5px 0",items:[{xtype:"combobox",name:"file0_format",fieldLabel:"File Format",labelWidth:180,width:350,value:"matrix",store:"FileFormats",queryMode:"local",displayField:"text",valueField:"name",editable:false},{xtype:"component",autoEl:{tag:"a",href:"http://enews.patricbrc.org/faqs/transcriptomics-faqs/upload-transcriptomics-data-to-workspace-faqs/#gene-matrix",html:"what's this?",target:"_blank"},listeners:{afterrender:function(a){a.mon(a.el,"click",function(){Ext.create("Ext.tip.ToolTip",{target:a.el,html:"File format describes how the expression data is orgnaized in your source file.  Gene Matrix format specifies gene identifiers in rows, samples in columns, and interior cells contain expression values as log-ratio.  Gene List format specifies gene ID, sample, and expressions value as log-ratio per row."})},this)}},padding:"0 0 0 15px"}]},{xtype:"container",padding:"5 80",items:[{xtype:"imagecomponent",src:"/patric/images/transcriptomics_uploader_rule.png"},{xtype:"imagecomponent",src:"/patric/images/transcriptomics_uploader_rule.png"}]},{xtype:"container",layout:"hbox",items:[{xtype:"filefield",name:"file0",buttonOnly:true,buttonText:"Choose File",fieldLabel:"Specify a file on your computer",labelWidth:180,width:256,listeners:{change:function(d,e,c){var a=e.split("\\");var b=a[a.length-1];d.up("form").getForm().findField("expression_filename").setValue(b)}}},{xtype:"displayfield",name:"expression_filename",padding:"0 0 0 20px"}]},{xtype:"imagecomponent",padding:"5 80",src:"/patric/images/transcriptomics_uploader_rule_or.png"},{xtype:"textfield",name:"remoteData_1",fieldLabel:"Specify a URL for a file",labelWidth:180,anchor:"100%",validator:function(b){var a=this.up("form").getForm().findField("file0");if(a.isValid()&&a.getValue()!=""){return true}else{if(Ext.form.field.VTypes.url(b)){return true}else{return false}}}},{xtype:"displayfield",padding:"15 0 0 0",value:"<b>Specify the comparison metadata to upload (optional)</b>"},{xtype:"container",layout:"hbox",padding:"0 0 5px 0",items:[{xtype:"combobox",name:"file1_type",fieldLabel:"File Type",labelWidth:180,width:350,value:"txt",store:"FileTypes",queryMode:"local",displayField:"text",valueField:"name",editable:false},{xtype:"component",autoEl:{tag:"a",href:"http://enews.patricbrc.org/data-upload-templates/",html:"download template",target:"_blank"},padding:"0 0 0 15px"}]},{xtype:"container",layout:"hbox",items:[{xtype:"filefield",name:"file1",buttonOnly:true,buttonText:"Choose File",fieldLabel:"Specify a file on your computer",labelWidth:180,width:256,listeners:{change:function(d,e,c){var a=e.split("\\");var b=a[a.length-1];d.up("form").getForm().findField("sample_filename").setValue(b)}}},{xtype:"displayfield",name:"sample_filename",padding:"0 0 0 20px"}]}],buttons:[{text:"Next",formBind:true,disabled:true,handler:function(a,b){Ext.Ajax.request({url:"/portal/portal/patric/BreadCrumb/TranscriptomicsUploaderWindow?action=b&cacheability=PAGE",params:{mode:"create_collection"},success:function(g){var d=Ext.JSON.decode(g.responseText);var j=d.token;var k=d.collection;var h=d.url;var l=d.success;var f={};if(l){uploader.params={baseUrl:h,authToken:j,collectionId:k};var c=a.up("form").getForm();f.data_type=c.findField("data_type").getValue();uploader.params.metaData=f;var e={file0_content:"expression",file0_orientation:"svg"};if(c.findField("file1").getValue()!=""){Ext.applyIf(e,{file1_format:"list",file1_content:"sample"})}if(c.findField("remoteData_1").getValue()!=""){Ext.applyIf(e,{remoteData_1_type:c.findField("file0_type").getValue(),remoteData_1_format:c.findField("file0_format").getValue(),remoteData_1_content:"expression",remoteData_1_orientation:"svg"})}if(c.isValid()){c.submit({url:h+"/Collection/"+k+"?http_accept=application/json&http_authorized_session=polyomic%20authorization_token%3D"+j,params:e,success:function(n,o){n.findField("expression_filename").setValue("");n.findField("sample_filename").setValue("");var m=new Ext.LoadMask(uploader.body,{msg:"Uploading your file"});m.show();Ext.Function.defer(function(){Ext.Ajax.request({url:"/portal/portal/patric/BreadCrumb/TranscriptomicsUploaderWindow?action=b&cacheability=PAGE",params:{mode:"parse_collection",collectionId:k},timeout:300000,success:function(p){uploader.params.parsed=Ext.JSON.decode(p.responseText);m.hide();if(uploader.params.parsed.success==true){Ext.getCmp("uploader").getComponent("breadcrumb").setActiveTab("step02");Ext.getCmp("uploader").getComponent("steps").setActiveTab("step02");Ext.getCmp("MapGeneIdentifiersPanel").initParsedResult()}else{Ext.Msg.alert("Fail",uploader.params.parsed.msg)}},failure:function(p){console.log("Parsing failed",p)}})},1000)},failure:function(m,n){console.log("Form submission failed",n)}})}}else{Ext.Msg.alert("Status",d.msg)}}})}}]});Ext.define("TranscriptomicsUploader.view.Viewport",{extend:"Ext.window.Window",title:"Upload Transcriptomics Data to Workspace",width:600,resizable:false,id:"uploader",params:{},items:[{xtype:"tabpanel",itemId:"breadcrumb",border:false,tabBar:{hidden:true},height:50,items:[{xtype:"imagecomponent",itemId:"step01",padding:3,src:"/patric/images/transcriptomics_uploader_step1.png"},{xtype:"imagecomponent",itemId:"step02",padding:3,src:"/patric/images/transcriptomics_uploader_step2.png"},{xtype:"imagecomponent",itemId:"step03",padding:3,src:"/patric/images/transcriptomics_uploader_step3.png"},{xtype:"imagecomponent",itemId:"step04",padding:3,src:"/patric/images/transcriptomics_uploader_step4.png"}]},{xtype:"tabpanel",itemId:"steps",border:false,tabBar:{hidden:true},items:[{xtype:"specifyfile",itemId:"step01",title:"Specify File"},{xtype:"mapgeneidentifiers",itemId:"step02",title:"Map Gene Identifiers"},{xtype:"describeexperiment",itemId:"step03",title:"Describe Experiment"},{xtype:"addtogroup",itemId:"step04",title:"Add to Group"}]}]});Ext.define("TranscriptomicsUploader.controller.ViewController",{extend:"Ext.app.Controller",models:["GenomeName"],views:["SpecifyFile","MapGeneIdentifiers","DescribeExperiment","AddToGroup"],stores:["DataTypes","FileTypes","FileFormats","GeneIDTypes","GenomeNames","WorkspaceGroups"]});Ext.application({name:"TranscriptomicsUploader",controllers:["ViewController"]});